<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="invoice_document_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-call="web.external_layout">
                    <t t-call="web.internal_layout">
                        <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
                        <style>
                            .page {
                                font-family: 'Calibri', sans-serif;
                                font-size: 0.7em;
                            }
                            h1 {
                                font-size: 14pt !important;
                                font-weight: bold !important;
                                text-align: center;
                                text-decoration: underline;
                            }
                            h5 {
                                font-size: 9pt !important;
                                font-weight: bold !important;
                            }
                            .body-text {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .body-text * {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .terms {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .terms * {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .signatures {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .signatures * {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .table-bordered th {
                                font-size: 7pt;
                                font-weight: bold;
                            }
                            .table-bordered td {
                                font-size: 7pt;
                                font-weight: normal;
                            }
                            table {
                                page-break-inside: auto;
                                width: 100%;
                                border-collapse: collapse;
                            }
                            tr {
                                page-break-inside: avoid;
                                page-break-after: auto;
                            }
                            thead {
                                display: table-header-group;
                            }
                            .table-bordered {
                                border: 1px solid black;
                                border-collapse: collapse;
                                width: 100%;
                            }
                            .table-bordered th,
                            .table-bordered td {
                                border: 1px solid black;
                                padding: 5px;
                                vertical-align: middle;
                            }
                            .table-bordered tr {
                                break-inside: avoid;
                            }
                            /* Ensure nested tables inherit vertical alignment */
                            .table-bordered table th,
                            .table-bordered table td {
                                vertical-align: middle;
                            }
                            .po-table {
                                width: 100%;
                                border-collapse: collapse;
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .po-table td {
                                padding-left: 5px;
                                border: 1px solid black;
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .po-table .text-center {
                                text-align: center;
                            }
                            .po-table .text-left {
                                text-align: left;
                            }
                            .po-table .text-left-padded {
                                text-align: left;
                                padding-left: 5px !important;
                            }
                            .po-table .width-60 {
                                width: 60%;
                            }
                            .po-table .width-50 {
                                width: 50%;
                            }
                            .po-table .width-21 {
                                width: 21%;
                            }
                            .po-table .width-39 {
                                width: 39%;
                            }
                            .po-table .width-18 {
                                width: 18%;
                            }
                            .po-table .width-22 {
                                width: 22%;
                            }
                            .po-table .width-35 {
                                width: 35%;
                            }
                            .po-table .width-45 {
                                width: 45%;
                            }
                            .po-table .width-40 {
                                width: 40%;
                            }
                            .po-table .width-1 {
                                width: 1%;
                                text-align: center;
                                padding-right:3px;
                            }
                            .po-table .width-34 {
                                width: 35%;
                            }
                            .po-table .width-44 {
                                width: 45%;
                            }
                            .po-table .width-65 {
                                width: 64%;
                            }
                            .po-table .width-55 {
                                width: 54%;
                            }
                            .po-table .border-right {
                                border-right: 1px solid black !important;
                            }
                            .po-table .inner-table {
                                width: 100%;
                                border-collapse: collapse;
                            }
                            .po-table .inner-table td {
                                border: none;
                                padding-left: 0;
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .po-table .inner-table .text-left-padded {
                                padding-left: 5px !important;
                            }
                            .header-table {
                                width: 40%;
                                margin-left: auto;
                                border-collapse: collapse;
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .header-table td {
                                border: 1px solid black;
                                padding: 5px;
                                text-align: center;
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .invoice-header {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .invoice-header td {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .invoice-title {
                                font-size: 30px !important;
                                font-weight: bold !important;
                                text-align: center;
                                color: #000000;
                                font-family: serif;
                            }
                            .narration-table td {
                                font-size: 9pt;
                                font-weight: bold;
                            }
                            .bill-ship-header {
                                background-color: #91b9f7;
                                font-size: 18px;
                            }
                        </style>
                    </t>
                    <div class="page">
                        <div>
                            <table class="table table-bordered invoice-header">
                                <thead>
                                    <tr>
                                        <td colspan="2">
                                            <div class="text-center">
                                                <h5><b>Eram Power Electronics Private Limited</b></h5>
                                                <span>Plot No.110-L / 1, Survey No.68</span><br/>
                                                <span>Electronic City Phase 1</span><br/>
                                                <span>Bengaluru,Karnataka - 560100, India,</span><br/>
                                                <span>CIN:U73100KA2021FTC155104 / GSTIN: 29AAGCE7876F1Z4</span><br/>
                                                <span>Mob. No: +91 9886068175, Email: coe@eramelectronics.com, www.eramelectronics.com</span>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr style="background-color:#99b9f7;">
                                        <td colspan="2" class="text-center invoice-title"
                                            style="vertical-align: middle;">
                                            TAX INVOICE
                                        </td>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">Invoice No: <span t-field="o.name"/> </td>
                                        <td class="w-50 text-left-padded">Transport Mode: <span t-field="o.e_transport_mode"/> </td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">Invoice Date: <span t-field="o.invoice_date"/> </td>
                                        <td class="text-left-padded">Payment Terms: <span t-field="o.invoice_payment_term_id"/> </td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">Reverse Charge (Y/N):
                                            <t t-if="o.e_reverse_charge">
                                                <span>Y</span>
                                            </t>
                                            <t t-else="">N</t>
                                        </td>
                                        <td class="text-left-padded">Buyer's Order No: <span t-field="o.e_buyer_order_no"/></td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">State: <span t-field="o.l10n_in_state_id"/></td>
                                        <td class="text-left-padded">Shipment Terms: <span t-field="o.e_shipment_terms"/> </td>
                                    </tr>
                                    <tr class="bill-ship-header">
                                        <td class="w-50" style="padding-left: 5px;"><b>Bill to Party</b></td>
                                        <td><b>Ship to Party</b></td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">Name: <span t-field="o.partner_id"/></td>
                                        <td class="text-left-padded">Name: <span t-field="o.e_ship_to_party"/></td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">
                                            Address: <span t-field="o.partner_id.street"/>,
                                                    <span t-field="o.partner_id.city"/>,
                                                    <span t-field="o.partner_id.state_id"/><br/>
                                            TEL: <span t-field="o.partner_id.phone"/> <br/>
                                            E-mail: <span t-field="o.partner_id.email"/> <br/>
                                        </td>
                                        <td class="text-left-padded">
                                            Address: <span t-field="o.e_ship_to_party.street"/>,
                                                    <span t-field="o.e_ship_to_party.city"/>,
                                                    <span t-field="o.e_ship_to_party.state_id"/><br/>
                                            TEL: <span t-field="o.e_ship_to_party.phone"/> <br/>
                                            E-mail: <span t-field="o.e_ship_to_party.email"/> <br/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="w-50" style="padding-left: 5px;">GSTIN - <span t-field="o.e_bill_vat"/></td>
                                        <td class="text-left-padded">GSTIN - <span t-field="o.e_ship_vat"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <t t-set="currency" t-value="o.currency_id"/>
                            <div class="mb-4">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th class="text-center" style="width: 8%">SI. No.</th>
                                            <th class="text-center">Product Name And Description</th>
                                            <th class="text-center">HSN/SAC Code</th>
                                            <th class="text-center">Qty</th>
                                            <th class="text-center">Unit Price (<span t-field="currency.name"/>)</th>
                                            <th class="text-center">Total Price (<span t-field="currency.name"/>)</th>
                                            <!-- Collect all taxes and sort alphabetically by name -->
                                            <t t-set="all_taxes" t-value="[]"/>
                                            <t t-foreach="o.invoice_line_ids" t-as="line">
                                                <t t-foreach="line.tax_ids" t-as="tax">
                                                    <t t-if="tax.amount_type == 'group'">
                                                        <t t-foreach="tax.children_tax_ids" t-as="child_tax">
                                                            <t t-set="all_taxes" t-value="all_taxes.append(child_tax) or all_taxes"/>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-set="all_taxes" t-value="all_taxes.append(tax) or all_taxes"/>
                                                    </t>
                                                </t>
                                            </t>
                                            <!-- Remove duplicates and sort by tax name -->
                                            <t t-set="unique_taxes" t-value="[]"/>
                                            <t t-set="seen_tax_ids" t-value="set()"/>
                                            <t t-foreach="all_taxes" t-as="tax">
                                                <t t-if="tax.id not in seen_tax_ids">
                                                    <t t-set="unique_taxes" t-value="unique_taxes.append(tax) or unique_taxes"/>
                                                    <t t-set="seen_tax_ids" t-value="seen_tax_ids.add(tax.id) or seen_tax_ids"/>
                                                </t>
                                            </t>
                                            <t t-set="sorted_taxes" t-value="sorted(unique_taxes, key=lambda x: x.name)"/>
                                            <!-- Create a column for each tax in sorted_taxes -->
                                            <t t-foreach="sorted_taxes" t-as="tax">
                                                <th class="text-center">
                                                    <span t-esc="tax.name"/> (<span t-field="currency.name"/>)
                                                </th>
                                            </t>
                                            <th class="text-center">Total Amount (<span t-field="currency.name"/>)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="o.invoice_line_ids" t-as="line">
                                            <tr>
                                                <td class="text-center"><span t-esc="line_index + 1"/></td>
                                                <td class="text-center"><span t-field="line.product_id"/><br/><span t-field="line.e_description"/></td>
                                                <td class="text-center"><span t-field="line.l10n_in_hsn_code"/></td>
                                                <td class="text-center"><span t-field="line.quantity"/></td>
                                                <td class="text-center"><span t-field="currency.symbol"/><span t-field="line.price_unit"/></td>
                                                <td class="text-center"><span t-field="line.price_subtotal"/></td>
                                                <!-- Calculate tax amounts for each tax in sorted_taxes -->
                                                <t t-set="line_taxes" t-value="{}"/>
                                                <t t-foreach="line.tax_ids" t-as="tax">
                                                    <t t-if="tax.amount_type == 'group'">
                                                        <t t-foreach="tax.children_tax_ids" t-as="child_tax">
                                                            <t t-set="line_taxes" t-value="line_taxes.update({child_tax.id: child_tax.amount / 100 * line.price_subtotal}) or line_taxes"/>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-set="line_taxes" t-value="line_taxes.update({tax.id: tax.amount / 100 * line.price_subtotal}) or line_taxes"/>
                                                    </t>
                                                </t>
                                                <!-- Display tax amounts for each tax in sorted_taxes -->
                                                <t t-foreach="sorted_taxes" t-as="tax">
                                                    <td class="text-center">
                                                        <t t-if="line_taxes.get(tax.id)">
                                                            <span t-field="currency.symbol"/><span t-esc="'%.2f' % line_taxes[tax.id]"/>
                                                        </t>
                                                        <t t-else="">-</t>
                                                    </td>
                                                </t>
                                                <td class="text-center" style="padding-right: 3px;"><span t-field="line.price_total"/></td>
                                            </tr>
                                        </t>
                                        <!-- Total row -->
                                        <tr class="text-end">
                                            <td colspan="5" style="font-weight: bold;">Total Amount(<span t-field="currency.name"/>)</td>
                                            <td class="text-center"><strong><span t-field="o.amount_untaxed"/></strong></td>
                                            <!-- Calculate total taxes for each tax in sorted_taxes -->
                                            <t t-set="total_taxes" t-value="{}"/>
                                            <t t-foreach="o.invoice_line_ids" t-as="line">
                                                <t t-foreach="line.tax_ids" t-as="tax">
                                                    <t t-if="tax.amount_type == 'group'">
                                                        <t t-foreach="tax.children_tax_ids" t-as="child_tax">
                                                            <t t-set="total_taxes" t-value="total_taxes.update({child_tax.id: total_taxes.get(child_tax.id, 0) + (child_tax.amount / 100 * line.price_subtotal)}) or total_taxes"/>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <t t-set="total_taxes" t-value="total_taxes.update({tax.id: total_taxes.get(tax.id, 0) + (tax.amount / 100 * line.price_subtotal)}) or total_taxes"/>
                                                    </t>
                                                </t>
                                            </t>
                                            <!-- Display total tax amounts -->
                                            <t t-foreach="sorted_taxes" t-as="tax">
                                                <td class="text-center">
                                                    <t t-if="total_taxes.get(tax.id)">
                                                        <strong><span t-field="currency.symbol"/> <span t-esc="'%.2f' % total_taxes[tax.id]"/></strong>
                                                    </t>
                                                    <t t-else="">-</t>
                                                </td>
                                            </t>
                                            <td class="text-center"><strong><span t-field="o.amount_total"/></strong></td>
                                        </tr>
                                        <tr class="text-start">
                                            <td colspan="100%" style="padding-left: 5px; font-weight: bold;">
                                                Total Invoice Amount In Words: <span t-field="o.e_amount_total_words"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <!-- Rest of the table for narration and certification -->
                                <table class="table table-bordered narration-table">
                                    <tr>
                                        <td style="width: 50%; vertical-align: middle; padding: 8px;" rowspan="4">
                                            <span t-field="o.narration"/>
                                        </td>
                                        <td style="padding: 8px;" class="text-center">
                                            Certified that the particulars given above are true and correct
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;" class="text-center">
                                            For Eram Power Electronics Private Limited
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="height: 75px;"/>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px;" class="text-center">
                                            Authorised signatory
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>